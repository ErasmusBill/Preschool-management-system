{% extends "school/base.html" %}
{% load static %}

{% block title %}Preskool - Edit Teacher{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="content container-fluid">
        <!-- Page Header -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="page-title">Edit Teacher</h3>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'teacher:list-teachers' %}">Teachers</a></li>
                        <li class="breadcrumb-item active">Edit Teacher</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- /Page Header -->

        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <!-- Display Messages -->
                        {% if messages %}
                        <div class="messages">
                            {% for message in messages %}
                            <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <form method="POST" action="{% url 'teacher:edit-teacher' teacher.id %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <div class="row">
                                <!-- Profile Picture -->
                                <div class="col-12">
                                    <h5 class="form-title"><span>Profile Picture</span></h5>
                                </div>
                                
                                <div class="col-12 text-center mb-4">
                                    <div id="profile-picture-container" class="profile-picture-container">
                                        {% if teacher.user.profile_picture %}
                                            <img id="profile-picture-preview" class="profile-picture-preview" 
                                                 src="{{ teacher.user.profile_picture.url }}" alt="Profile preview">
                                        {% else %}
                                            <img id="profile-picture-preview" class="profile-picture-preview" 
                                                 alt="Profile preview" style="display: none;">
                                            <div id="profile-picture-placeholder" class="profile-picture-placeholder">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        {% endif %}
                                        <div class="profile-picture-overlay">
                                            <i class="fas fa-camera"></i>
                                            <span>Change Image</span>
                                        </div>
                                    </div>

                                    <input type="file" id="profile_picture" name="profile_picture" accept="image/*" style="display: none;">
                                    <div class="mt-3">
                                        <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger" 
                                                {% if not teacher.user.profile_picture %}style="display: none;"{% endif %}>
                                            <i class="fas fa-trash"></i> Remove Image
                                        </button>
                                        <button type="button" id="upload-image" class="btn btn-sm btn-primary">
                                            <i class="fas fa-upload"></i> Select Image
                                        </button>
                                    </div>
                                    <div class="text-muted small mt-2">JPG, PNG or GIF (Max 2MB)</div>
                                    <div id="file-error" class="text-danger small mt-2" style="display: none;"></div>
                                    <!-- Debug info (remove in production) -->
                                    <div id="debug-info" class="text-info small mt-2" style="display: none;"></div>
                                </div>

                                <!-- Basic Details -->
                                <div class="col-12">
                                    <h5 class="form-title"><span>Basic Details</span></h5>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>First Name *</label>
                                        <input type="text" class="form-control" name="first_name" value="{{ teacher.user.first_name }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Last Name *</label>
                                        <input type="text" class="form-control" name="last_name" value="{{ teacher.user.last_name }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Gender *</label>
                                        <select class="form-control" name="gender" required>
                                            <option value="">Select Gender</option>
                                            <option value="M" {% if teacher.gender == 'M' %}selected{% endif %}>Male</option>
                                            <option value="F" {% if teacher.gender == 'F' %}selected{% endif %}>Female</option>
                                            <option value="O" {% if teacher.gender == 'O' %}selected{% endif %}>Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Date of Birth *</label>
                                        <input type="date" class="form-control" name="date_of_birth" value="{{ teacher.date_of_birth|date:'Y-m-d' }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Mobile *</label>
                                        <input type="text" class="form-control" name="mobile" value="{{ teacher.mobile }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Department *</label>
                                        <select class="form-control" name="department" required>
                                            <option value="">Select Department</option>
                                            {% for department in departments %}
                                                <option value="{{ department.id }}" {% if teacher.department_id.id == department.id %}selected{% endif %}>{{ department.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Joining Date *</label>
                                        <input type="date" class="form-control" name="joining_date" value="{{ teacher.joining_date|date:'Y-m-d' }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Qualification *</label>
                                        <input class="form-control" type="text" name="qualification" value="{{ teacher.qualification }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Experience (Years) *</label>
                                        <input class="form-control" type="number" name="experience" value="{{ teacher.experience }}" min="0" step="0.1" required>
                                    </div>
                                </div>
                                
                                <!-- Login Details -->
                                <div class="col-12">
                                    <h5 class="form-title"><span>Login Details</span></h5>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Email ID *</label>
                                        <input type="email" class="form-control" name="email" value="{{ teacher.user.email }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Password (Leave blank to keep current password)</label>
                                        <input type="password" class="form-control" name="password" placeholder="Enter new password">
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Repeat Password</label>
                                        <input type="password" class="form-control" name="repeat_password" placeholder="Repeat new password">
                                    </div>
                                </div>
                                
                                <!-- Address -->
                                <div class="col-12">
                                    <h5 class="form-title"><span>Address</span></h5>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label>Address *</label>
                                        <input type="text" class="form-control" name="address" value="{{ teacher.address }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>City *</label>
                                        <input type="text" class="form-control" name="city" value="{{ teacher.city }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Zip Code *</label>
                                        <input type="text" class="form-control" name="zipcode" value="{{ teacher.zipcode }}" required>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-6">
                                    <div class="form-group">
                                        <label>Country *</label>
                                        <input type="text" class="form-control" name="country" value="{{ teacher.country }}" required>
                                    </div>
                                </div>
                                
                                <div class="col-12 mt-3">
                                    <button type="submit" class="btn btn-primary">Update Teacher</button>
                                    <a href="{% url 'teacher:list-teachers' %}" class="btn btn-secondary">Cancel</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .profile-picture-container {
        position: relative;
        display: inline-block;
        width: 150px;
        height: 150px;
        cursor: pointer;
        margin-bottom: 15px;
    }
    .profile-picture-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #ddd;
    }
    .profile-picture-placeholder {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
    }
    .profile-picture-placeholder i {
        font-size: 48px;
    }
    .profile-picture-overlay {
        position: absolute;
        top: 0; 
        left: 0;
        width: 100%; 
        height: 100%;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        color: white;
        font-size: 12px;
        pointer-events: none; /* Prevent overlay from blocking clicks */
    }
    .profile-picture-overlay i {
        font-size: 24px;
        margin-bottom: 5px;
    }
    .profile-picture-container:hover .profile-picture-overlay {
        opacity: 1;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Debug function (remove in production)
        function debugLog(message) {
            console.log('[File Upload Debug]:', message);
            $('#debug-info').text(message).show();
            setTimeout(() => $('#debug-info').hide(), 3000);
        }

        // Check if jQuery is loaded
        if (typeof $ === 'undefined') {
            alert('jQuery is not loaded! Please check your base template.');
            return;
        }

        debugLog('jQuery loaded, initializing file upload...');

        const preview = $('#profile-picture-preview');
        const placeholder = $('#profile-picture-placeholder');
        const fileInput = $('#profile_picture');
        const removeButton = $('#remove-image');
        const uploadButton = $('#upload-image');
        const container = $('#profile-picture-container');
        const fileError = $('#file-error');

        // Check if all elements exist
        if (fileInput.length === 0) {
            alert('File input element not found!');
            return;
        }
        if (uploadButton.length === 0) {
            alert('Upload button not found!');
            return;
        }

        debugLog(`Elements found: fileInput(${fileInput.length}), uploadButton(${uploadButton.length})`);
        
        // Initialize based on current image
        function initializePreviewState() {
            if (preview.attr('src') && preview.attr('src') !== '#' && preview.attr('src') !== '') {
                preview.show();
                placeholder.hide();
                removeButton.show();
                debugLog('Initialized with existing image');
            } else {
                preview.hide();
                placeholder.show();
                removeButton.hide();
                debugLog('Initialized without image');
            }
            fileError.hide();
        }
        initializePreviewState();
        
        // Primary upload button click handler
        uploadButton.on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            debugLog('Upload button clicked');
            
            try {
                // Multiple attempts to trigger file dialog
                fileInput[0].click(); // jQuery element to DOM element
                debugLog('File input clicked successfully');
            } catch (error) {
                debugLog('Error clicking file input: ' + error.message);
                alert('Error opening file dialog: ' + error.message);
            }
        });

        // Alternative method using native JavaScript
        uploadButton[0].addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            debugLog('Native event listener triggered');
            
            setTimeout(() => {
                try {
                    document.getElementById('profile_picture').click();
                    debugLog('Native file input click successful');
                } catch (error) {
                    debugLog('Native click failed: ' + error.message);
                }
            }, 100);
        });
        
        // Container click (for overlay) - with improved event handling
        container.on('click', function(e) {
            // Don't trigger if clicking on buttons
            if ($(e.target).closest('#remove-image, #upload-image').length > 0) {
                debugLog('Click on button ignored');
                return;
            }
            
            debugLog('Container clicked');
            e.preventDefault();
            
            try {
                fileInput[0].click();
                debugLog('Container click triggered file input');
            } catch (error) {
                debugLog('Container click failed: ' + error.message);
            }
        });
        
        // Handle file selection
        fileInput.on('change', function(e) {
            debugLog('File input change event triggered');
            
            if (this.files && this.files[0]) {
                const file = this.files[0];
                debugLog(`File selected: ${file.name}, Size: ${(file.size/1024/1024).toFixed(2)}MB, Type: ${file.type}`);
                
                // Validate file type
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                if (!validTypes.includes(file.type.toLowerCase())) {
                    fileError.text('Please select a valid image file (JPG, PNG or GIF)').show();
                    this.value = '';
                    debugLog('Invalid file type rejected');
                    return;
                }
                
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    fileError.text('Image must be less than 2MB').show();
                    this.value = '';
                    debugLog('File too large rejected');
                    return;
                }
                
                // Clear any previous errors
                fileError.hide();
                
                // Preview image
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.attr('src', e.target.result).show();
                    placeholder.hide();
                    removeButton.show();
                    debugLog('Image preview updated successfully');
                };
                reader.onerror = function() {
                    debugLog('FileReader error occurred');
                    fileError.text('Error reading file').show();
                };
                reader.readAsDataURL(file);
            } else {
                debugLog('No file selected or files array empty');
            }
        });
        
        // Remove image
        removeButton.on('click', function(e) {
            e.stopPropagation(); // Prevent triggering container click
            e.preventDefault();
            
            fileInput.val('');
            preview.attr('src', '').hide();
            placeholder.show();
            removeButton.hide();
            fileError.hide();
            debugLog('Image removed');
        });
        
        // Form validation
        $('form').on('submit', function(e) {
            debugLog('Form submission started');
            
            // Password validation
            const password = $('input[name="password"]').val();
            const repeatPassword = $('input[name="repeat_password"]').val();
            
            if (password !== repeatPassword) {
                e.preventDefault();
                alert('Passwords do not match!');
                return false;
            }
            
            if (password && password.length < 6) {
                e.preventDefault();
                alert('Password must be at least 6 characters long!');
                return false;
            }
            
            // File validation
            if (fileInput[0].files.length > 0) {
                const file = fileInput[0].files[0];
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                
                if (!validTypes.includes(file.type.toLowerCase())) {
                    e.preventDefault();
                    fileError.text('Please select a valid image file (JPG, PNG or GIF)').show();
                    return false;
                }
                
                if (file.size > 2 * 1024 * 1024) {
                    e.preventDefault();
                    fileError.text('Image must be less than 2MB').show();
                    return false;
                }
                
                debugLog('File validation passed');
            }
            
            debugLog('Form validation completed successfully');
        });

        // Additional debugging - check for common issues
        setTimeout(() => {
            debugLog('Post-load checks completed');
            
            // Test if file input is accessible
            try {
                const testAccess = document.getElementById('profile_picture');
                if (testAccess) {
                    debugLog('File input accessible via DOM');
                } else {
                    debugLog('ERROR: File input not accessible via DOM');
                }
            } catch (error) {
                debugLog('DOM access error: ' + error.message);
            }
            
            // Check for overlapping elements
            const uploadRect = uploadButton[0].getBoundingClientRect();
            debugLog(`Upload button position: ${uploadRect.top}, ${uploadRect.left}, ${uploadRect.width}x${uploadRect.height}`);
            
        }, 1000);
    });
</script>
{% endblock %}