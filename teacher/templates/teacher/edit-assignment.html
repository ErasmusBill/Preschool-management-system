{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>Preskool - Edit Assignment</title>
  <link rel="shortcut icon" href="{% static 'assets/img/favicon.png' %}">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="{% static 'assets/plugins/bootstrap/css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'assets/plugins/fontawesome/css/fontawesome.min.css' %}">
  <link rel="stylesheet" href="{% static 'assets/plugins/fontawesome/css/all.min.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
  <style>
    /* Global Styles from Teacher Dashboard */
    .file-upload-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    .file-upload-input {
      position: absolute;
      left: -9999px;
    }
    .file-upload-btn {
      border: 2px dashed #ddd;
      padding: 2.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 10px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    }
    .file-upload-btn:hover {
      border-color: #007bff;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      transform: scale(1.02);
    }
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      transition: all 0.3s ease;
    }
    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      color: white;
    }
    .card-header {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-bottom: 2px solid #dee2e6;
    }
    .breadcrumb {
      background: transparent;
      padding: 0;
    }
    .breadcrumb-item + .breadcrumb-item::before {
      content: "›";
      color: #6c757d;
    }
    /* Specific Add Assignment Styles */
    .guidelines h6 {
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .guidelines ul {
      padding-left: 1.25rem;
      margin-bottom: 1rem;
    }
    .guidelines ul li {
      margin-bottom: 0.25rem;
    }
    .form-group label {
      font-weight: 500;
    }
    .text-danger {
      font-size: 0.875rem;
    }
    /* Sidebar Info Panel */
    .info-section {
      border-left: 4px solid #667eea;
      padding-left: 1rem;
      margin-bottom: 1.5rem;
    }
    .info-title {
      font-weight: 600;
      color: #495057;
      margin-bottom: 0.5rem;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }
    .info-label {
      color: #6c757d;
    }
    .info-value {
      font-weight: 500;
    }
    .current-file {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }
    .current-file i {
      color: #007bff;
      font-size: 1.5rem;
      margin-right: 0.75rem;
    }
    .current-file strong {
      color: #333;
    }
    .current-file small {
      color: #6c757d;
    }
    .alert-warning {
      border-left: 4px solid #ffc107;
    }
  </style>
</head>
<body>
<div class="main-wrapper">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <a href="{% url 'school:dashboard' %}" class="logo">
        <img src="{% static 'assets/img/logo.png' %}" alt="Logo">
      </a>
      <a href="{% url 'school:dashboard' %}" class="logo logo-small">
        <img src="{% static 'assets/img/logo-small.png' %}" alt="Logo" width="30" height="30">
      </a>
    </div>
    <a href="javascript:void(0);" id="toggle_btn"><i class="fas fa-align-left"></i></a>
    <div class="top-nav-search">
      <form>
        <input type="text" class="form-control" placeholder="Search...">
        <button class="btn" type="submit"><i class="fas fa-search"></i></button>
      </form>
    </div>
    <a class="mobile_btn" id="mobile_btn"><i class="fas fa-bars"></i></a>
    <!-- User Menu -->
    <ul class="nav user-menu">
      <!-- Notifications -->
      <li class="nav-item dropdown noti-dropdown">
        <a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown">
          <i class="far fa-bell"></i> <span class="badge badge-pill">3</span>
        </a>
        <div class="dropdown-menu notifications">
          <div class="topnav-dropdown-header">
            <span class="notification-title">Notifications</span>
            <a href="javascript:void(0)" class="clear-noti"> Clear All </a>
          </div>
          <div class="noti-content">
            <ul class="notification-list">
              <li class="notification-message">
                <a href="#">
                  <div class="media">
                    <span class="avatar avatar-sm">
                      <img class="avatar-img rounded-circle" src="{% static 'assets/img/profiles/avatar-02.jpg' %}" alt="User Image">
                    </span>
                    <div class="media-body">
                      <p class="noti-details"><span class="noti-title">New Assignment</span> submission from <span class="noti-title">John Doe</span></p>
                      <p class="noti-time"><span class="notification-time">5 mins ago</span></p>
                    </div>
                  </div>
                </a>
              </li>
            </ul>
          </div>
          <div class="topnav-dropdown-footer">
            <a href="#">View all Notifications</a>
          </div>
        </div>
      </li>
      <!-- Profile Dropdown -->
      <li class="nav-item dropdown has-arrow">
        <a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown">
          <span class="user-img">
            <img class="rounded-circle" src="{% static 'assets/img/profiles/avatar-01.jpg' %}" width="31" alt="{{ user.first_name }}">
          </span>
        </a>
        <div class="dropdown-menu">
          <div class="user-header">
            <div class="avatar avatar-sm">
              <img src="{% static 'assets/img/profiles/avatar-01.jpg' %}" class="avatar-img rounded-circle" alt="User">
            </div>
            <div class="user-text">
              <h6>{{ user.first_name }} {{ user.last_name }}</h6>
              <p class="text-muted mb-0">{{ user.role|title }}</p>
            </div>
          </div>
          <a class="dropdown-item" href="#"><i class="fas fa-user mr-2"></i>My Profile</a>
          <a class="dropdown-item" href="#"><i class="fas fa-inbox mr-2"></i>Inbox</a>
          <a class="dropdown-item" href="{% url 'home_auth:logout' %}"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
        </div>
      </li>
    </ul>
  </div>
  <!-- /Header -->

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-inner slimscroll">
      <div id="sidebar-menu" class="sidebar-menu">
        <ul>
          <li class="menu-title"><span>Main Menu</span></li>
          <li class="submenu">
            <a href="#"><i class="fas fa-chalkboard-teacher"></i> <span> Teacher Menu</span> <span class="menu-arrow"></span></a>
            <ul>
              <li><a href="{% url 'school:dashboard' %}">Teacher Dashboard</a></li>
              <li><a href="{% url 'teacher:list-teachers' %}">All Teachers</a></li>
              <li><a href="#">My Classes</a></li>
              <li><a href="#">Students</a></li>
            </ul>
          </li>
          <!-- Assignment Management Submenu -->
          <li class="submenu active">
            <a href="#"><i class="fas fa-tasks"></i> <span> Assignment Management</span> <span class="menu-arrow"></span></a>
            <ul>
              <li><a href="{% url 'teacher:add-assignment' %}">Add Assignment</a></li>
              <li><a href="{% url 'teacher:list-assignments' teacher.id %}">List All Assignments</a></li>
              <li><a href="#">My Assignments</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <!-- /Sidebar -->

  <!-- Page Wrapper -->
  <div class="page-wrapper">
    <div class="content container-fluid">

      <!-- Page Header -->
      <div class="page-header">
        <div class="row">
          <div class="col-sm-12">
            <h3 class="page-title">Edit Assignment</h3>
            <ul class="breadcrumb">
              <li class="breadcrumb-item"><a href="{% url 'school:dashboard' %}">Dashboard</a></li>
              <li class="breadcrumb-item"><a href="{% url 'teacher:list-assignments' teacher.id %}">Assignments</a></li>
              <li class="breadcrumb-item active">Edit Assignment</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Edit Assignment Form -->
      <div class="row">
        <div class="col-lg-8 col-md-12">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title"><i class="fas fa-edit mr-2"></i>Edit Assignment Details</h4>
            </div>
            <div class="card-body">
              <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Display form errors -->
                {% if form.non_field_errors %}
                  <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                  </div>
                {% endif %}

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.subject.id_for_label }}"><i class="fas fa-book mr-2"></i>Subject <span class="text-danger">*</span></label>
                      {{ form.subject }}
                      {% if form.subject.errors %}
                        <div class="text-danger small mt-1">{{ form.subject.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.assignment_class.id_for_label }}"><i class="fas fa-users mr-2"></i>Class <span class="text-danger">*</span></label>
                      {{ form.assignment_class }}
                      {% if form.assignment_class.errors %}
                        <div class="text-danger small mt-1">{{ form.assignment_class.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.start_time.id_for_label }}"><i class="fas fa-play-circle mr-2"></i>Start Date & Time <span class="text-danger">*</span></label>
                      {{ form.start_time }}
                      {% if form.start_time.errors %}
                        <div class="text-danger small mt-1">{{ form.start_time.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.due_time.id_for_label }}"><i class="fas fa-clock mr-2"></i>Due Date & Time <span class="text-danger">*</span></label>
                      {{ form.due_time }}
                      {% if form.due_time.errors %}
                        <div class="text-danger small mt-1">{{ form.due_time.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="{{ form.max_score.id_for_label }}"><i class="fas fa-trophy mr-2"></i>Maximum Score <span class="text-danger">*</span></label>
                  <div class="input-group">
                    {{ form.max_score }}
                    <div class="input-group-append">
                      <span class="input-group-text">points</span>
                    </div>
                  </div>
                  {% if form.max_score.errors %}
                    <div class="text-danger small mt-1">{{ form.max_score.errors }}</div>
                  {% endif %}
                </div>

                <div class="form-group">
                  <label for="{{ form.assignment.id_for_label }}"><i class="fas fa-file-upload mr-2"></i>Assignment File</label>
                  
                  <!-- Current File Preview -->
                  {% if assignment.assignment %}
                    <div class="current-file">
                      <i class="fas fa-paperclip"></i>
                      <div>
                        <strong>{{ assignment.assignment.name }}</strong><br>
                        <small>{{ assignment.assignment.size|filesizeformat }}</small>
                      </div>
                      <div class="ml-auto">
                        <a href="{{ assignment.assignment.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                          <i class="fas fa-eye mr-1"></i> View
                        </a>
                      </div>
                    </div>
                    <small class="text-muted d-block mt-2">Leave empty to keep current file, or upload a new file to replace it.</small>
                  {% endif %}

                  <div class="file-upload-wrapper mt-3">
                    {{ form.assignment }}
                    <div class="file-upload-btn" onclick="document.getElementById('{{ form.assignment.id_for_label }}').click()">
                      <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                      <p class="mb-1 font-weight-bold">Click to upload new assignment file</p>
                      <small class="text-muted">PDF, DOC, DOCX files allowed (Max: 10MB)</small>
                    </div>
                  </div>
                  
                  {% if form.assignment.errors %}
                    <div class="text-danger small mt-1">{{ form.assignment.errors }}</div>
                  {% endif %}
                </div>

                <div class="row">
                  <div class="col-12">
                    <button type="submit" class="btn btn-gradient btn-lg">
                      <i class="fas fa-save mr-2"></i> Update Assignment
                    </button>
                    <a href="{% url 'teacher:assignment-detail' assignment.id %}" class="btn btn-secondary btn-lg ml-2">
                      <i class="fas fa-arrow-left mr-2"></i> Cancel
                    </a>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Assignment Info Sidebar -->
        <div class="col-lg-4 col-md-12">
          <div class="card stats-card">
            <div class="card-header">
              <h4 class="card-title"><i class="fas fa-info-circle mr-2"></i>Assignment Information</h4>
            </div>
            <div class="card-body">
              <div class="info-section">
                <h6 class="info-title">Details</h6>
                <div class="info-row">
                  <span class="info-label">Created:</span>
                  <span class="info-value">{{ assignment.created_at|date:"M d, Y" }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Last Updated:</span>
                  <span class="info-value">{{ assignment.updated_at|date:"M d, Y" }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Status:</span>
                  <span class="info-value">
                    {% now "Y-m-d H:i:s" as current_time %}
                    {% if assignment.due_time|date:"Y-m-d H:i:s" < current_time %}
                      <span class="badge badge-danger">Overdue</span>
                    {% elif assignment.start_time|date:"Y-m-d H:i:s" > current_time %}
                      <span class="badge badge-info">Upcoming</span>
                    {% else %}
                      <span class="badge badge-success">Active</span>
                    {% endif %}
                  </span>
                </div>
                <div class="info-row">
                  <span class="info-label">Submissions:</span>
                  <span class="info-value">{{ submissions_count|default:"0" }}</span>
                </div>
              </div>

              <hr>

              <div class="alert alert-warning">
                <h6><i class="fas fa-exclamation-triangle mr-2"></i>Important Notes</h6>
                <ul class="mb-0 pl-3">
                  <li>Changes will affect all students immediately</li>
                  <li>Extending the due date will notify students automatically</li>
                  <li>Replacing the file will update it for all students</li>
                  <li>Editing subject or class may affect student groupings</li>
                </ul>
              </div>

              <div class="text-center mt-4">
                <a href="{% url 'teacher:delete-assignment' assignment.id %}" class="btn btn-outline-danger btn-sm" 
                   onclick="return confirmDelete('{{ assignment.subject.name }}')">
                  <i class="fas fa-trash mr-1"></i> Delete This Assignment
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer>
  <p>Copyright © 2025 Preskool. All rights reserved.</p>
</footer>

<!-- Scripts -->
<script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'assets/js/popper.min.js' %}"></script>
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'assets/js/script.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // File upload preview
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadBtn = document.querySelector('.file-upload-btn');
            if (file) {
                // Validate file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    this.value = '';
                    return;
                }
                // Validate file type
                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Only PDF, DOC, and DOCX files are allowed');
                    this.value = '';
                    return;
                }
                // Update UI
                const fileIcon = getFileIcon(file.name);
                uploadBtn.innerHTML = `
                    <i class="${fileIcon} fa-3x text-success mb-3"></i>
                    <p class="mb-1 font-weight-bold">${file.name}</p>
                    <small class="text-muted">${formatFileSize(file.size)}</small>
                `;
                uploadBtn.style.borderColor = '#28a745';
                uploadBtn.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
            }
        });
    }

    // Form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const startTime = document.querySelector('input[name="start_time"]');
            const dueTime = document.querySelector('input[name="due_time"]');
            if (startTime && dueTime) {
                const startDate = new Date(startTime.value);
                const dueDate = new Date(dueTime.value);
                const now = new Date();
                // Check if due date is before start date
                if (startDate >= dueDate) {
                    e.preventDefault();
                    alert('Due date must be after start date');
                    return false;
                }
                // Warn if start date is in the past
                if (startDate < now) {
                    if (!confirm('Start date is in the past. Do you want to continue?')) {
                        e.preventDefault();
                        return false;
                    }
                }
                // Warn if assignment duration is too short
                const diffHours = (dueDate - startDate) / (1000 * 60 * 60);
                if (diffHours < 24) {
                    if (!confirm('Assignment duration is less than 24 hours. Students might not have enough time. Continue?')) {
                        e.preventDefault();
                        return false;
                    }
                }
            }
        });
    }
});

// Utility functions
function getFileIcon(filename) {
    const extension = filename.split('.').pop().toLowerCase();
    switch (extension) {
        case 'pdf':
            return 'fas fa-file-pdf';
        case 'doc':
        case 'docx':
            return 'fas fa-file-word';
        default:
            return 'fas fa-file-alt';
    }
}
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Confirmation dialog for delete actions
function confirmDelete(assignmentTitle) {
    return confirm(`Are you sure you want to delete the assignment "${assignmentTitle}"?
This action cannot be undone and will remove all associated submissions and grades.`);
}
</script>
</body>
</html>