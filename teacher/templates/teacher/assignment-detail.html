{% extends 'base_school.html' %}
{% load static %}

{% block title %}All Assignments{% endblock %}

{% block extra_css %}
<style>
  .table {
    margin-bottom: 0;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  
  .table th,
  .table td {
    vertical-align: middle;
  }

  .table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
    border-top: none;
  }

  .table-hover tbody tr:hover {
    background-color: #f1f8ff;
  }

  .status-badge {
    font-size: 0.75rem;
    padding: 0.3rem 0.7rem;
    border-radius: 20px;
    font-weight: 600;
    display: inline-block;
  }

  .due-soon {
    background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
    color: #d63031;
    border: 1px solid #fdcb6e;
  }

  .overdue {
    background: linear-gradient(135deg, #ff7675, #d63031);
    color: white;
    border: 1px solid #d63031;
  }

  .upcoming {
    background: linear-gradient(135deg, #74b9ff, #0984e3);
    color: white;
    border: 1px solid #0984e3;
  }

  .action-btn {
    padding: 0.3rem 0.6rem;
    font-size: 0.85rem;
    border-radius: 5px;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .action-btn.edit {
    background: #ffc107;
    color: #212529;
  }

  .action-btn.delete {
    background: #dc3545;
    color: white;
  }

  .action-btn.edit:hover {
    background: #e0a800;
    transform: translateY(-1px);
  }

  .action-btn.delete:hover {
    background: #c82333;
    transform: translateY(-1px);
  }

  .filter-section {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #4a6cf7;
  }

  .form-control-sm {
    height: calc(1.8em + 0.5rem + 2px);
    font-size: 0.875rem;
  }

  .btn-outline-primary {
    border-color: #4a6cf7;
    color: #4a6cf7;
  }

  .btn-outline-primary:hover {
    background: #4a6cf7;
    color: white;
  }

  .text-center {
    text-align: center !important;
  }

  .no-data {
    text-align: center;
    padding: 4rem;
    color: #6c757d;
  }

  .no-data i {
    font-size: 3rem;
    opacity: 0.3;
    margin-bottom: 1rem;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .table-responsive {
      overflow-x: auto;
    }
    .table th,
    .table td {
      white-space: nowrap;
    }
    .action-btn {
      padding: 0.2rem 0.5rem;
      font-size: 0.8rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div class="row align-items-center">
    <div class="col-sm-6">
      <h3 class="page-title">Assignment Management</h3>
      <ul class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'school:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">All Assignments</li>
      </ul>
    </div>
    <div class="col-sm-6 text-right">
      <a href="{% url 'teacher:add-assignment' %}" class="btn btn-gradient">
        <i class="fas fa-plus-circle mr-2"></i> Add New Assignment
      </a>
    </div>
  </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-xl-3 col-sm-6 col-12">
    <div class="card stats-card">
      <div class="card-body">
        <div class="dash-widget-header">
          <span class="dash-widget-icon text-primary border-primary">
            <i class="fas fa-tasks"></i>
          </span>
          <div class="dash-count">
            <h3>{{ total_assignments|default:"0" }}</h3>
          </div>
        </div>
        <div class="dash-widget-info">
          <h6 class="text-muted">Total Assignments</h6>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-sm-6 col-12">
    <div class="card stats-card">
      <div class="card-body">
        <div class="dash-widget-header">
          <span class="dash-widget-icon text-success border-success">
            <i class="fas fa-play-circle"></i>
          </span>
          <div class="dash-count">
            <h3>{{ active_assignments|default:"0" }}</h3>
          </div>
        </div>
        <div class="dash-widget-info">
          <h6 class="text-muted">Active</h6>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-sm-6 col-12">
    <div class="card stats-card">
      <div class="card-body">
        <div class="dash-widget-header">
          <span class="dash-widget-icon text-danger border-danger">
            <i class="fas fa-exclamation-triangle"></i>
          </span>
          <div class="dash-count">
            <h3>{{ overdue_assignments|default:"0" }}</h3>
          </div>
        </div>
        <div class="dash-widget-info">
          <h6 class="text-muted">Overdue</h6>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-sm-6 col-12">
    <div class="card stats-card">
      <div class="card-body">
        <div class="dash-widget-header">
          <span class="dash-widget-icon text-info border-info">
            <i class="fas fa-clock"></i>
          </span>
          <div class="dash-count">
            <h3>{{ upcoming_assignments|default:"0" }}</h3>
          </div>
        </div>
        <div class="dash-widget-info">
          <h6 class="text-muted">Upcoming</h6>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filter & Search Section -->
<div class="filter-section">
  <div class="row">
    <div class="col-md-3">
      <label><i class="fas fa-book mr-1"></i>Subject</label>
      <select class="form-control form-control-sm" id="subjectFilter">
        <option value="">All Subjects</option>
        {% for subject in subjects %}
          <option value="{{ subject.name|lower }}">{{ subject.name }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="col-md-3">
      <label><i class="fas fa-users mr-1"></i>Class</label>
      <select class="form-control form-control-sm" id="classFilter">
        <option value="">All Classes</option>
        <option value="creche">Creche</option>
        <option value="nursery_1">Nursery 1</option>
        <option value="nursery_2">Nursery 2</option>
        <option value="kindergarten">Kindergarten</option>
        <option value="upper_primary_4">Upper Primary 4</option>
        <option value="upper_primary_5">Upper Primary 5</option>
        <option value="upper_primary_6">Upper Primary 6</option>
        <option value="jhs_1">JHS 1</option>
        <option value="jhs_2">JHS 2</option>
        <option value="jhs_3">JHS 3</option>
      </select>
    </div>
    
    <div class="col-md-3">
      <label><i class="fas fa-filter mr-1"></i>Status</label>
      <select class="form-control form-control-sm" id="statusFilter">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="upcoming">Upcoming</option>
        <option value="overdue">Overdue</option>
      </select>
    </div>
    
    <div class="col-md-3">
      <label><i class="fas fa-search mr-1"></i>Search</label>
      <input type="text" class="form-control form-control-sm" id="assignmentSearch" placeholder="Search by subject, class, or teacher...">
    </div>
  </div>
</div>

<!-- Assignments Table -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th>Subject</th>
            <th>Class</th>
            <th>Start Date & Time</th>
            <th>Due Date & Time</th>
            <th>Max Score</th>
            <th>File</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="assignmentsTableBody">
          {% if assignments %}
            {% for assignment in assignments %}
              <tr 
                data-subject="{{ assignment.subject.name|lower }}"
                data-class="{{ assignment.assignment_class|lower }}"
                data-start-time="{{ assignment.start_time|date:'Y-m-d H:i:s' }}"
                data-due-time="{{ assignment.due_time|date:'Y-m-d H:i:s' }}"
                data-status="{% now 'Y-m-d H:i:s' as now %}{% if assignment.due_time|date:'Y-m-d H:i:s' < now %}overdue{% elif assignment.start_time|date:'Y-m-d H:i:s' > now %}upcoming{% else %}active{% endif %}">
                <td>{{ assignment.subject.name|default:"No Subject" }}</td>
                <td>{{ assignment.get_assignment_class_display }}</td>
                <td>
                  {{ assignment.start_time|date:"M d, Y" }}<br>
                  <small class="text-muted">{{ assignment.start_time|time:"g:i A" }}</small>
                </td>
                <td>
                  {{ assignment.due_time|date:"M d, Y" }}<br>
                  <small class="text-muted">{{ assignment.due_time|time:"g:i A" }}</small>
                </td>
                <td>{{ assignment.max_score }} pts</td>
                <td>
                  {% if assignment.assignment %}
                    <a href="{{ assignment.assignment.url }}" target="_blank" class="text-primary">
                      <i class="fas fa-file-alt mr-1"></i> View File
                    </a>
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
                <td>
                  {% now "Y-m-d H:i:s" as current_time %}
                  {% if assignment.due_time|date:"Y-m-d H:i:s" < current_time %}
                    <span class="status-badge overdue">Overdue</span>
                  {% elif assignment.start_time|date:"Y-m-d H:i:s" > current_time %}
                    <span class="status-badge upcoming">Upcoming</span>
                  {% else %}
                    <span class="status-badge due-soon">Active</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <a href="{% url 'teacher:assignment-detail' assignment.id %}" class="action-btn" title="View Details">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="{% url 'teacher:edit-assignment' assignment.id %}" class="action-btn edit" title="Edit Assignment">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'teacher:delete-assignment' assignment.id %}" class="action-btn delete" title="Delete Assignment" onclick="return confirmDelete('{{ assignment.subject.name|default:"Assignment" }}')">
                    <i class="fas fa-trash"></i>
                  </a>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="no-data">
                <i class="fas fa-tasks"></i>
                <h5 class="mt-3">No Assignments Found</h5>
                <p>You haven't created any assignments yet.</p>
                <a href="{% url 'teacher:add-assignment' %}" class="btn btn-gradient btn-sm mt-3">
                  <i class="fas fa-plus-circle mr-1"></i>Create Your First Assignment
                </a>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination (if needed) -->
{% if is_paginated %}
  <nav aria-label="Assignment pagination" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1">&laquo; First</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
      {% endif %}

      <li class="page-item active">
        <span class="page-link">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const subjectFilter = document.getElementById('subjectFilter');
    const classFilter = document.getElementById('classFilter');
    const statusFilter = document.getElementById('statusFilter');
    const searchInput = document.getElementById('assignmentSearch');
    const tableRows = document.querySelectorAll('#assignmentsTableBody tr');

    function filterAssignments() {
        const subjectValue = subjectFilter.value.toLowerCase();
        const classValue = classFilter.value.toLowerCase();
        const statusValue = statusFilter.value.toLowerCase();
        const searchValue = searchInput.value.toLowerCase();

        let visibleCount = 0;

        tableRows.forEach(row => {
            const subjectText = row.dataset.subject || '';
            const classText = row.dataset.class || '';
            const statusText = row.dataset.status || '';
            const rowText = row.textContent.toLowerCase();

            const matchesSubject = !subjectValue || subjectText.includes(subjectValue);
            const matchesClass = !classValue || classText.includes(classValue);
            const matchesStatus = !statusValue || statusText === statusValue;
            const matchesSearch = !searchValue || rowText.includes(searchValue);

            if (matchesSubject && matchesClass && matchesStatus && matchesSearch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Show/hide "No Data" message
        const noDataRow = document.querySelector('.no-data');
        if (noDataRow) {
            noDataRow.closest('tr').style.display = visibleCount === 0 && tableRows.length > 0 ? '' : 'none';
        }
    }

    [subjectFilter, classFilter, statusFilter].forEach(el => {
        el.addEventListener('change', filterAssignments);
    });
    searchInput.addEventListener('keyup', filterAssignments);

    // Real-time status update
    function updateStatuses() {
        const now = new Date();

        tableRows.forEach(row => {
            const startTime = new Date(row.dataset.startTime);
            const dueTime = new Date(row.dataset.dueTime);
            const statusCell = row.querySelector('td:nth-child(7) .status-badge');

            if (!statusCell) return;

            if (now > dueTime) {
                statusCell.className = 'status-badge overdue';
                statusCell.textContent = 'Overdue';
            } else if (now < startTime) {
                statusCell.className = 'status-badge upcoming';
                statusCell.textContent = 'Upcoming';
            } else {
                statusCell.className = 'status-badge due-soon';
                statusCell.textContent = 'Active';
            }
        });

        updateStatsCards();
    }

    function updateStatsCards() {
        const total = tableRows.length;
        let active = 0, overdue = 0, upcoming = 0;

        tableRows.forEach(row => {
            const status = row.dataset.status;
            if (status === 'active') active++;
            else if (status === 'overdue') overdue++;
            else if (status === 'upcoming') upcoming++;
        });

        document.querySelector('.total-assignments').textContent = total;
        document.querySelector('.active-assignments').textContent = active;
        document.querySelector('.overdue-assignments').textContent = overdue;
        document.querySelector('.upcoming-assignments').textContent = upcoming;
    }

    // Initial update
    updateStatuses();
    setInterval(updateStatuses, 60000); // Every minute
});

function confirmDelete(assignmentTitle) {
    return confirm(`Are you sure you want to delete "${assignmentTitle}"? This action cannot be undone.`);
}
</script>
{% endblock %}